<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>SPIR-V 初探 (一) - Fragment Shader - libreliu&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="简介本文主要关注 SPIR-V 1.6。 前面分支 &#x2F; 循环 &#x2F; 函数等测试主要是在 Fragment 这种 OpEntrypoint 下调用的子函数内部进行测试的。 下面的实验基本使用 Shader Playground 的 glslang trunk (上面写使用的 2022-09-19 的版本)，其中：  Shader stage 选择 frag Target 选择 Vu">
<meta property="og:type" content="article">
<meta property="og:title" content="SPIR-V 初探 (一) - Fragment Shader">
<meta property="og:url" content="https://blog.libreliu.info/play-with-spirv/">
<meta property="og:site_name" content="libreliu&#39;s blog">
<meta property="og:description" content="简介本文主要关注 SPIR-V 1.6。 前面分支 &#x2F; 循环 &#x2F; 函数等测试主要是在 Fragment 这种 OpEntrypoint 下调用的子函数内部进行测试的。 下面的实验基本使用 Shader Playground 的 glslang trunk (上面写使用的 2022-09-19 的版本)，其中：  Shader stage 选择 frag Target 选择 Vu">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-03-28T16:00:00.000Z">
<meta property="article:modified_time" content="2023-03-28T16:00:00.000Z">
<meta property="article:author" content="Libre Liu">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/css/images/logo.png">
  
  <link href="/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
  <link href="/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">
  
<link rel="stylesheet" href="/css/style.css">

  

<meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="libreliu's blog" type="application/atom+xml">
</head>

<body>
  <div id="container">
    <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-inner" class="inner">
      <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
      <a id="logo" class="logo" href="/"></a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/paper-summary">Paper Reading</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form">
            <input type="search" name="q" class="search-form-input" placeholder="Search">
            <button type="submit" class="search-form-submit">&#xF002;</button>
            <input type="hidden" name="sitesearch"  value="blog.libreliu.info">
          </form>
          <!-- <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://blog.libreliu.info"></form> -->
        </div>
      </nav>
    </div>
  </div>
</header>

    <br>
    <section id="main" class="outer"><article id="post-play-with-spirv" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      SPIR-V 初探 (一) - Fragment Shader
      <small class=article-detail-date-index>&nbsp; 2023-03-29</small>
    </h1>
  


        <div class=page-title></div>
        <br>
      </header>
    
    <div class="article-meta">
      <!--<a href="/play-with-spirv/" class="article-date">
  <time datetime="2023-03-28T16:00:00.000Z" itemprop="datePublished">2023-03-29</time>
</a>-->
      <!-- 
--><!-- by blair 160724 -->
      <!-- by blair
      
      -->
    </div>
    <div class="article-entry" itemprop="articleBody">
      
      
      
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>本文主要关注 SPIR-V 1.6。</p>
<p>前面分支 &#x2F; 循环 &#x2F; 函数等测试主要是在 Fragment 这种 OpEntrypoint 下调用的子函数内部进行测试的。</p>
<p>下面的实验基本使用 <a target="_blank" rel="noopener" href="https://shader-playground.timjones.io/">Shader Playground</a> 的 glslang trunk (上面写使用的 2022-09-19 的版本)，其中：</p>
<ul>
<li>Shader stage 选择 <strong>frag</strong></li>
<li>Target 选择 Vulkan 1.3</li>
<li>Output format 选择 SPIR-V</li>
</ul>
<h3 id="See-Also"><a href="#See-Also" class="headerlink" title="See Also"></a>See Also</h3><ul>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Structured_program_theorem">https://en.wikipedia.org/wiki/Structured_program_theorem</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/leaningtech/solving-the-structured-control-flow-problem-once-and-for-all-5123117b1ee2">https://medium.com/leaningtech/solving-the-structured-control-flow-problem-once-and-for-all-5123117b1ee2</a></li>
</ul>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><blockquote>
<p>通过例子来学习 SPIR-V 会比较快捷，也比较容易理解。</p>
<p>SPIR-V 本身是 SSA 形式的 IR，且指令 format 较为规整，易于解析 (虽然大家都是调库，也不会用手解析 SPIR-V 的)。</p>
<p>规范文档参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://registry.khronos.org/SPIR-V/">Khronos SPIR-V Registry</a></li>
<li><a target="_blank" rel="noopener" href="https://registry.khronos.org/SPIR-V/specs/unified1/SPIRV.html">SPIR-V Unified Specifications</a></li>
</ul>
<p>同时推荐用 <a target="_blank" rel="noopener" href="https://shader-playground.timjones.io/">Shader Playground</a> 来方便直接看到 SPIR-V Disassembly。</p>
<p>据博主本人测试，OpenAI 的 GPT-4 有<strong>不错</strong>的 SPIR-V 到 GLSL 反汇编能力。</p>
</blockquote>
<h3 id="Layout"><a href="#Layout" class="headerlink" title="Layout"></a>Layout</h3><p>从反汇编结果可以看到，SPIR-V Module 有比较整齐的形式，事实上这些形式是规定好的：<a target="_blank" rel="noopener" href="https://registry.khronos.org/SPIR-V/specs/unified1/SPIRV.html#_logical_layout_of_a_module">Logical Layout of a Module - SPIR-V Specification</a>。</p>
<h3 id="概观"><a href="#概观" class="headerlink" title="概观"></a>概观</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 310 es</span></span><br><span class="line">precision highp <span class="type">float</span>;</span><br><span class="line">precision highp <span class="type">int</span>;</span><br><span class="line">precision mediump sampler3D;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">; SPIR-V</span><br><span class="line">; Version: 1.6</span><br><span class="line">; Generator: Khronos Glslang Reference Front End; 10</span><br><span class="line">; Bound: 6                                                  ; Bound; where all &lt;id&gt;s in this module are</span><br><span class="line">                                                            ; guaranteed to satisfy 0 &lt; id &lt; Bound</span><br><span class="line">; Schema: 0                                                 ; Instruction Schema; Reserved, not used for now</span><br><span class="line">               OpCapability Shader</span><br><span class="line">          %1 = OpExtInstImport &quot;GLSL.std.450&quot;</span><br><span class="line">               OpMemoryModel Logical GLSL450                ; Addressing model = Logical</span><br><span class="line">                                                            ; Logical 模式下面，指针只能从已有的对象中创建，指针的地址也都是假的</span><br><span class="line">                                                            ;   （也就是说，不能把指针的值拷贝到别的变量中去）</span><br><span class="line">                                                            ; 也有一些带有物理指针的 Addressing Model 和相应的 Memory Model</span><br><span class="line">                                                            ;   =&gt; 留待后文探索</span><br><span class="line">                                                            ; Memory Model = GLSL450</span><br><span class="line">               OpEntryPoint Fragment %main &quot;main&quot;           ; Execution Model = Fragment</span><br><span class="line">                                                            ; Entrypoint = %main (用 OpFunction 定义的某个 Result ID)</span><br><span class="line">                                                            ; Name = &quot;main&quot; (Entrypoint 要有一个字符串名字)</span><br><span class="line">               OpExecutionMode %main OriginUpperLeft        ; The coordinates decorated by FragCoord</span><br><span class="line">                                                            ; appear to originate in the upper left,</span><br><span class="line">                                                            ; and increase toward the right and downward.</span><br><span class="line">                                                            ; Only valid with the Fragment Execution Model.</span><br><span class="line">               OpSource ESSL 310                            ; 标记源语言; ESSL = OpenGL ES Shader Language</span><br><span class="line">               OpName %main &quot;main&quot;</span><br><span class="line">       %void = OpTypeVoid</span><br><span class="line">          %3 = OpTypeFunction %void</span><br><span class="line">       %main = OpFunction %void None %3</span><br><span class="line">          %5 = OpLabel</span><br><span class="line">               OpReturn</span><br><span class="line">               OpFunctionEnd</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里会发现 %main 这个 result id 是在后面定义的，但是前面却引用到了。</p>
<p>对于 <code>SPV_OPERAND_TYPE_ID</code>, <code>SPV_OPERAND_TYPE_MEMORY_SEMANTICS_ID</code>, <code>SPV_OPERAND_TYPE_SCOPE_ID</code> 来说，正常都需要先定义（是某个指令的 result id）再引用，但是可以前向定义的指令除外。</p>
<p>可前向定义的指令可以参考 <a target="_blank" rel="noopener" href="https://github.com/KhronosGroup/SPIRV-Tools/blob/1021ec302f568cd83fee9f4eaa763dadb66e40b0/source/val/validate_id.cpp#L49">source&#x2F;val&#x2F;validate_id.cpp:L122 @ SPIRV-Tools</a>，其中包括：</p>
<ul>
<li>全部的 <code>OpTypeXXX</code> 类指令</li>
<li>其它一大堆，主要是执行模式等 metadata、Decorate、分支、device side invoke 等<ul>
<li>可以参考 <code>spvOperandCanBeForwardDeclaredFunction (source/operand.cpp @ SPIRV-Tools)</code> 这个函数</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="简单的函数"><a href="#简单的函数" class="headerlink" title="简单的函数"></a>简单的函数</h3><p>函数定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 310 es</span></span><br><span class="line"></span><br><span class="line"><span class="type">float</span> <span class="title function_">Circle</span><span class="params">( vec2 uv, vec2 p, <span class="type">float</span> r, <span class="type">float</span> blur )</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> d = length(uv - p);</span><br><span class="line">    <span class="type">float</span> c = smoothstep(r, r-blur, d);</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// skip some lines</span></span><br></pre></td></tr></table></figure>

<p>SPIR-V 反汇编：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">; == 相关定义 ==</span><br><span class="line">%1 = OpExtInstImport &quot;GLSL.std.450&quot;                        ; 引入外部指令集</span><br><span class="line">%float = OpTypeFloat 32</span><br><span class="line">%v2float = OpTypeVector %float 2</span><br><span class="line">%_ptr_Function_v2float = OpTypePointer Function %v2float</span><br><span class="line">%_ptr_Function_float = OpTypePointer Function %float       ; 定义指针类型，指向的变量的 Storage Class 为 Function</span><br><span class="line">%10 = OpTypeFunction %float %_ptr_Function_v2float %_ptr_Function_v2float %_ptr_Function_float %_ptr_Function_float</span><br><span class="line"></span><br><span class="line">; == 函数 ==</span><br><span class="line">%Circle_vf2_vf2_f1_f1_ = OpFunction %float None %10        ; 返回值类型 %float，Function Control 类型无</span><br><span class="line">                                                           ; 函数类型 %10 - float (vec2, vec2, float, float)</span><br><span class="line">         %uv = OpFunctionParameter %_ptr_Function_v2float  ; 拿到各个 parameter 的 result id</span><br><span class="line">          %p = OpFunctionParameter %_ptr_Function_v2float  </span><br><span class="line">          %r = OpFunctionParameter %_ptr_Function_float    </span><br><span class="line">       %blur = OpFunctionParameter %_ptr_Function_float    </span><br><span class="line">         %16 = OpLabel                                     ; 一个基本块的开始 (2.2.5. Control Flow)</span><br><span class="line">          %d = OpVariable %_ptr_Function_float Function    ; 定义 float 变量, Storage Class 为 Function </span><br><span class="line">          %c = OpVariable %_ptr_Function_float Function    ; =&gt; 变量可以被 OpLoad / OpStore</span><br><span class="line">         %39 = OpLoad %v2float %uv                         ; 结果类型 %v2float, 装载 %uv 变量的值</span><br><span class="line">         %40 = OpLoad %v2float %p</span><br><span class="line">         %41 = OpFSub %v2float %39 %40                     ; Operand2 - Operand1，结果类型 %v2float</span><br><span class="line">         %42 = OpExtInst %float %1 Length %41              ; Execute an instruction in an imported set of extended instructions</span><br><span class="line">                                                           ; Set (也就是这里的 %1) is the result of an OpExtInstImport instruction.</span><br><span class="line">                                                           ; 后面的 Set 中的 Instruction 是 “Length”，操作数是 %41</span><br><span class="line">               OpStore %d %42                              ; 存到 %d 变量的存储中</span><br><span class="line">         %44 = OpLoad %float %r</span><br><span class="line">         %45 = OpLoad %float %r</span><br><span class="line">         %46 = OpLoad %float %blur</span><br><span class="line">         %47 = OpFSub %float %45 %46                       ; %blur - %r</span><br><span class="line">         %48 = OpLoad %float %d</span><br><span class="line">         %49 = OpExtInst %float %1 SmoothStep %44 %47 %48  ; SmoothStep(%r, %blur - %r, %d)</span><br><span class="line">               OpStore %c %49</span><br><span class="line">         %50 = OpLoad %float %c</span><br><span class="line">               OpReturnValue %50                           ; 不返回值的话使用 OpReturn</span><br><span class="line">               OpFunctionEnd</span><br></pre></td></tr></table></figure>

<h3 id="函数的-in-x2F-out-参数"><a href="#函数的-in-x2F-out-参数" class="headerlink" title="函数的 in &#x2F; out 参数"></a>函数的 in &#x2F; out 参数</h3><p>函数定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">inoutTest</span><span class="params">(in vec2 uv, out <span class="type">float</span> o1, in <span class="type">float</span> i2, out vec2 o2)</span> &#123;</span><br><span class="line">    o2 = uv;</span><br><span class="line">    o1 = i2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">       %main = OpFunction %void None %3</span><br><span class="line">          %5 = OpLabel</span><br><span class="line">         %v1 = OpVariable %_ptr_Function_v2float Function</span><br><span class="line">         %t1 = OpVariable %_ptr_Function_float Function</span><br><span class="line">         %t2 = OpVariable %_ptr_Function_float Function</span><br><span class="line">         %v2 = OpVariable %_ptr_Function_v2float Function</span><br><span class="line">      %param = OpVariable %_ptr_Function_v2float Function</span><br><span class="line">    %param_0 = OpVariable %_ptr_Function_float Function</span><br><span class="line">    %param_1 = OpVariable %_ptr_Function_float Function</span><br><span class="line">    %param_2 = OpVariable %_ptr_Function_v2float Function</span><br><span class="line">         %24 = OpLoad %v2float %v1</span><br><span class="line">               OpStore %param %24</span><br><span class="line">         %27 = OpLoad %float %t2</span><br><span class="line">               OpStore %param_1 %27</span><br><span class="line">         %29 = OpFunctionCall %void %inoutTest_vf2_f1_f1_vf2_ %param %param_0 %param_1 %param_2</span><br><span class="line">         %30 = OpLoad %float %param_0   ; 可以看到，就是实现了 %param_0 变量内值的变化</span><br><span class="line">               OpStore %t1 %30</span><br><span class="line">         %31 = OpLoad %v2float %param_2</span><br><span class="line">               OpStore %v2 %31</span><br><span class="line">               OpStore %fragColor %38</span><br><span class="line">               OpReturn</span><br><span class="line">               OpFunctionEnd</span><br><span class="line">%inoutTest_vf2_f1_f1_vf2_ = OpFunction %void None %10</span><br><span class="line">         %uv = OpFunctionParameter %_ptr_Function_v2float</span><br><span class="line">         %o1 = OpFunctionParameter %_ptr_Function_float</span><br><span class="line">         %i2 = OpFunctionParameter %_ptr_Function_float</span><br><span class="line">         %o2 = OpFunctionParameter %_ptr_Function_v2float</span><br><span class="line"></span><br><span class="line">         %16 = OpLabel</span><br><span class="line">         %17 = OpLoad %v2float %uv</span><br><span class="line">               OpStore %o2 %17</span><br><span class="line">         %18 = OpLoad %float %i2</span><br><span class="line">               OpStore %o1 %18</span><br><span class="line">               OpReturn</span><br><span class="line">               OpFunctionEnd</span><br></pre></td></tr></table></figure>

<h3 id="分支"><a href="#分支" class="headerlink" title="分支"></a>分支</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 310 es</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">testIf</span><span class="params">(<span class="type">float</span> range)</span> &#123;</span><br><span class="line">    <span class="type">int</span> c = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (range &lt; <span class="number">1.0</span>)</span><br><span class="line">        c = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        c = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// skip some lines</span></span><br></pre></td></tr></table></figure>

<p>SPIR-V 反汇编：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">; == 相关定义 ==</span><br><span class="line">      %int_0 = OpConstant %int 0</span><br><span class="line">    %float_1 = OpConstant %float 1</span><br><span class="line"></span><br><span class="line">; == 函数 ==</span><br><span class="line"> %testIf_f1_ = OpFunction %int None %22</span><br><span class="line">      %range = OpFunctionParameter %_ptr_Function_float</span><br><span class="line">         %25 = OpLabel                                    ; 基本块开始</span><br><span class="line">        %c_0 = OpVariable %_ptr_Function_int Function</span><br><span class="line">               OpStore %c_0 %int_0</span><br><span class="line">         %68 = OpLoad %float %range                       </span><br><span class="line">         %71 = OpFOrdLessThan %bool %68 %float_1          ; check if %68 (loaded from %range) &lt; %float_1</span><br><span class="line">               OpSelectionMerge %73 None                  ; Declare a structured selection</span><br><span class="line">                                                          ; This instruction must immediately precede either an OpBranchConditional or OpSwitch instruction. That is, it must be the second-to-last instruction in its block.</span><br><span class="line">                                                          ; Selection Control = None; 这里可以给 Hint 提示此分支是否应该 remove</span><br><span class="line">                                                          ; 并且指定 Merge Block 为 %73，也就是分支结束的地方</span><br><span class="line">               OpBranchConditional %71 %72 %75            ; 如果 %71 为 true, 则跳到 %72 标号，否则跳到 %75 标号 - 标志基本块结束</span><br><span class="line">         %72 = OpLabel                                    ; </span><br><span class="line">               OpStore %c_0 %int_1</span><br><span class="line">               OpBranch %73                               ; Unconditional branch to %73</span><br><span class="line">         %75 = OpLabel</span><br><span class="line">               OpStore %c_0 %int_2</span><br><span class="line">               OpBranch %73</span><br><span class="line">         %73 = OpLabel</span><br><span class="line">         %77 = OpLoad %int %c_0</span><br><span class="line">               OpReturnValue %77</span><br><span class="line">               OpFunctionEnd</span><br></pre></td></tr></table></figure>

<p>总结：</p>
<ol>
<li><code>OpSelectionMerge</code></li>
<li><code>OpBranchConditional</code></li>
<li>两个基本块最后 <code>OpBranch</code> 到出口</li>
</ol>
<h3 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h3><h4 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h4><ul>
<li>Merge Instruction: <code>OpSelectionMerge</code> 或者 <code>OpLoopMerge</code> 两者之一，用在</li>
<li>Header Block: 包含 Merge Instruction 的 Block<ul>
<li>Loop Header: Merge Instruction 是 <code>OpLoopMerge</code> 的 Header Block</li>
<li>Selection Header: <code>OpSelectionMerge</code> 为 Merge Instruction, <code>OpBranchConditional</code> 是终止指令的 Header Block</li>
<li>Switch Header: <code>OpSelectionMerge</code> 为 Merge Instruction, <code>OpSwitch</code> 是终止指令的 Header Block</li>
</ul>
</li>
<li>Merge Block: 在 Merge Instruction 作为 Merge Block 操作数的 Block</li>
<li>Break Block: 含有跳转到被 Loop Header 的 Merge Instruction 定义为 Merge Block 的 Block</li>
<li>Continue Block: 含有跳转到 <code>OpLoopMerge</code> 指令的 Continue Target 的 Block</li>
<li>Return Block: 包含 <code>OpReturn</code> 或者 <code>OpReturnValue</code> 的 Block</li>
</ul>
<blockquote>
<p>GPT-4: 在 SPIR-V 中，Merge Block 是一个特定类型的基本块（Basic Block），用于控制流程结构中收敛控制流的位置。当你在 SPIR-V 中使用分支结构（如 if-else 语句、循环等）时，Merge Block 表示在这些分支结构末端的汇合点。</p>
<p>SPIR-V 中的控制流结构使用特殊的操作码（如 OpSelectionMerge、OpLoopMerge）来定义。这些操作码告诉编译器如何解释控制流图（Control Flow Graph，CFG）。Merge Block 用于表示这些控制流结构的结束位置，它是控制流从不同路径重新合并到一条路径的地方。例如，一个 if-else 语句会有两个分支，这两个分支在 Merge Block 之后合并为单个执行路径。</p>
</blockquote>
<h4 id="while-循环-无-break"><a href="#while-循环-无-break" class="headerlink" title="while 循环 - 无 break"></a>while 循环 - 无 break</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">testWhile</span><span class="params">(<span class="type">int</span> count)</span> &#123;</span><br><span class="line">    <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (count &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        sum++;</span><br><span class="line">        count--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">%testWhile_i1_ = OpFunction %int None %27</span><br><span class="line">      %count = OpFunctionParameter %_ptr_Function_int</span><br><span class="line">         %30 = OpLabel</span><br><span class="line">        %sum = OpVariable %_ptr_Function_int Function</span><br><span class="line">               OpStore %sum %int_0</span><br><span class="line">               OpBranch %85</span><br><span class="line">         %85 = OpLabel</span><br><span class="line">               OpLoopMerge %87 %88 None                 ; Declare a structured loop.</span><br><span class="line">                                                        ; This instruction must immediately precede</span><br><span class="line">                                                        ; either an OpBranch or OpBranchConditional </span><br><span class="line">                                                        ; instruction. </span><br><span class="line">                                                        ; That is, it must be the second-to-last </span><br><span class="line">                                                        ; instruction in its block.</span><br><span class="line">                                                        ; Merge Block = %87</span><br><span class="line">                                                        ; Continue target = %88</span><br><span class="line">               OpBranch %89</span><br><span class="line">         %89 = OpLabel</span><br><span class="line">         %90 = OpLoad %int %count</span><br><span class="line">         %91 = OpSGreaterThanEqual %bool %90 %int_0     ; 有符号比较; if %90 (=count) &gt;= %int_0 (0)</span><br><span class="line">               OpBranchConditional %91 %86 %87          ; %91 == true ? jump to %86 : jump to %87 (FINISH)</span><br><span class="line">         %86 = OpLabel</span><br><span class="line">         %92 = OpLoad %int %sum</span><br><span class="line">         %93 = OpIAdd %int %92 %int_1</span><br><span class="line">               OpStore %sum %93                         ; sum = sum + 1</span><br><span class="line">         %94 = OpLoad %int %count</span><br><span class="line">         %95 = OpISub %int %94 %int_1</span><br><span class="line">               OpStore %count %95                       ; count = count - 1</span><br><span class="line">               OpBranch %88</span><br><span class="line">         %88 = OpLabel</span><br><span class="line">               OpBranch %85                             ; 无条件回到 Loop 头</span><br><span class="line">         %87 = OpLabel</span><br><span class="line">         %96 = OpLoad %int %sum</span><br><span class="line">               OpReturnValue %96</span><br><span class="line">               OpFunctionEnd</span><br></pre></td></tr></table></figure>

<p>相当于翻译成了如下格式的 SPIR-V：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">%header_block = OpLabel</span><br><span class="line">                OpLoopMerge %merge_block %continue_block</span><br><span class="line">                OpBranch %loop_body</span><br><span class="line"></span><br><span class="line">   %loop_test = OpLabel</span><br><span class="line">                OpLoopMerge %loop_merge %loop_cont</span><br><span class="line"></span><br><span class="line">   %loop_cond = ...          ; Some calculations</span><br><span class="line">                OpBranchConditional %loop_cond %loop_body %loop_merge</span><br><span class="line">   </span><br><span class="line">   %loop_body = OpLabel</span><br><span class="line">                ...          ; Some codes inside loop body</span><br><span class="line">                OpBranch %loop_cont</span><br><span class="line"></span><br><span class="line">   %loop_cont = OpLabel</span><br><span class="line">                OpBranch %loop_test</span><br><span class="line"></span><br><span class="line">  %loop_merge = OpLabel</span><br><span class="line">                ...          ; The &quot;following&quot; basic block</span><br></pre></td></tr></table></figure>

<h4 id="while-循环-带-break"><a href="#while-循环-带-break" class="headerlink" title="while 循环 - 带 break"></a>while 循环 - 带 break</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">testWhile</span><span class="params">(<span class="type">int</span> count)</span> &#123;</span><br><span class="line">    <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (count &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        sum++;</span><br><span class="line">        count--;</span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SPIR-V 反汇编：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">%testWhile_i1_ = OpFunction %int None %27</span><br><span class="line">      %count = OpFunctionParameter %_ptr_Function_int</span><br><span class="line">         %30 = OpLabel</span><br><span class="line">        %sum = OpVariable %_ptr_Function_int Function</span><br><span class="line">               OpStore %sum %int_0</span><br><span class="line">               OpBranch %85</span><br><span class="line"></span><br><span class="line">         %85 = OpLabel</span><br><span class="line">               OpLoopMerge %87 %88 None</span><br><span class="line">               OpBranch %89</span><br><span class="line"></span><br><span class="line">         %89 = OpLabel</span><br><span class="line">         %90 = OpLoad %int %count</span><br><span class="line">         %91 = OpSGreaterThanEqual %bool %90 %int_0</span><br><span class="line">               OpBranchConditional %91 %86 %87</span><br><span class="line"></span><br><span class="line">         %86 = OpLabel</span><br><span class="line">         %92 = OpLoad %int %sum</span><br><span class="line">         %93 = OpIAdd %int %92 %int_1</span><br><span class="line">               OpStore %sum %93</span><br><span class="line">         %94 = OpLoad %int %count</span><br><span class="line">         %95 = OpISub %int %94 %int_1</span><br><span class="line">               OpStore %count %95</span><br><span class="line">         %96 = OpLoad %int %count</span><br><span class="line">         %97 = OpIEqual %bool %96 %int_2</span><br><span class="line">               OpSelectionMerge %99 None              ; If 的 Merge Block = %99</span><br><span class="line">               OpBranchConditional %97 %98 %99</span><br><span class="line"></span><br><span class="line">         %98 = OpLabel</span><br><span class="line">               OpBranch %87                           ; =&gt; break out of the loop =&gt; emit instruction</span><br><span class="line">                                                      ;    to branch to while&#x27;s merge block</span><br><span class="line"></span><br><span class="line">         %99 = OpLabel                                ; 正常走 =&gt; 到达 while 末尾 =&gt; emit 到 while</span><br><span class="line">               OpBranch %88                           ; 的 Continue Block</span><br><span class="line"></span><br><span class="line">         %88 = OpLabel                                ; Continue Block </span><br><span class="line">               OpBranch %85</span><br><span class="line"></span><br><span class="line">         %87 = OpLabel                                ; Merge Block</span><br><span class="line">        %101 = OpLoad %int %sum</span><br><span class="line">               OpReturnValue %101</span><br><span class="line">               OpFunctionEnd</span><br></pre></td></tr></table></figure>

<p>总结：</p>
<ul>
<li>break 作为一个基本块末尾，直接 emit 无条件 branch 来跳到 while 循环的 merge block。</li>
</ul>
<h4 id="for-循环"><a href="#for-循环" class="headerlink" title="for 循环"></a>for 循环</h4><p>GLSL 代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">testFor</span><span class="params">(<span class="type">int</span> count)</span> &#123;</span><br><span class="line">    <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        sum += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SPIR-V 反汇编：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">%testFor_i1_ = OpFunction %int None %27</span><br><span class="line">    %count_0 = OpFunctionParameter %_ptr_Function_int</span><br><span class="line"></span><br><span class="line">         %33 = OpLabel</span><br><span class="line">      %sum_0 = OpVariable %_ptr_Function_int Function</span><br><span class="line">          %i = OpVariable %_ptr_Function_int Function</span><br><span class="line">               OpStore %sum_0 %int_0</span><br><span class="line">               OpStore %i %int_0</span><br><span class="line">               OpBranch %109</span><br><span class="line"></span><br><span class="line">        %109 = OpLabel</span><br><span class="line">               OpLoopMerge %111 %112 None</span><br><span class="line">               OpBranch %113</span><br><span class="line"></span><br><span class="line">        %113 = OpLabel</span><br><span class="line">        %114 = OpLoad %int %i</span><br><span class="line">        %115 = OpLoad %int %count_0</span><br><span class="line">        %116 = OpSLessThan %bool %114 %115</span><br><span class="line">               OpBranchConditional %116 %110 %111</span><br><span class="line"></span><br><span class="line">        %110 = OpLabel</span><br><span class="line">        %117 = OpLoad %int %sum_0</span><br><span class="line">        %118 = OpIAdd %int %117 %int_1</span><br><span class="line">               OpStore %sum_0 %118</span><br><span class="line">               OpBranch %112</span><br><span class="line"></span><br><span class="line">        %112 = OpLabel                              ; Continuation Block</span><br><span class="line">        %119 = OpLoad %int %i                       ; for 循环的循环结束操作放到了这里</span><br><span class="line">        %120 = OpIAdd %int %119 %int_1</span><br><span class="line">               OpStore %i %120</span><br><span class="line">               OpBranch %109</span><br><span class="line"></span><br><span class="line">        %111 = OpLabel                              ; Merge Block</span><br><span class="line">        %121 = OpLoad %int %sum_0</span><br><span class="line">               OpReturnValue %121</span><br><span class="line">               OpFunctionEnd</span><br></pre></td></tr></table></figure>

<p>总结：</p>
<ul>
<li>Continuation Block 处现在 emit 了循环后维护操作</li>
</ul>
<h3 id="Uniform、BuiltIn-等其它-Scope-的变量"><a href="#Uniform、BuiltIn-等其它-Scope-的变量" class="headerlink" title="Uniform、BuiltIn 等其它 Scope 的变量"></a>Uniform、BuiltIn 等其它 Scope 的变量</h3><blockquote>
<p><code>OpSource</code>, <code>OpName</code>, <code>OpMemberName</code> 属于调试信息。</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 310 es</span></span><br><span class="line">precision highp <span class="type">float</span>;</span><br><span class="line">precision highp <span class="type">int</span>;</span><br><span class="line">precision mediump sampler3D;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Anonymous uniform block - Import member names to shader directly</span></span><br><span class="line">layout(binding = <span class="number">0</span>) uniform uniBlock &#123;</span><br><span class="line">    uniform vec3 lightPos;</span><br><span class="line">    uniform <span class="type">float</span> someOtherFloat;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">layout(location = <span class="number">0</span>) out vec4 outColor;</span><br><span class="line">layout(location = <span class="number">0</span>) in vec4 vertColor;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This will not work:</span></span><br><span class="line"><span class="comment">// layout(binding = 0) uniform vec3 lightPos;</span></span><br><span class="line"><span class="comment">//  &#x27;non-opaque uniforms outside a block&#x27; : not allowed when using GLSL for Vulkan </span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">mainImage</span><span class="params">(out vec4 c, in vec2 f, in vec3 lightPos)</span> &#123;&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span> &#123;mainImage(outColor, gl_FragCoord.xy, lightPos);&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Input-x2F-Output"><a href="#Input-x2F-Output" class="headerlink" title="Input &#x2F; Output"></a>Input &#x2F; Output</h4><blockquote>
<p>所有可选 Decoration 可以参考 <a target="_blank" rel="noopener" href="https://registry.khronos.org/SPIR-V/specs/unified1/SPIRV.html#Decoration">https://registry.khronos.org/SPIR-V/specs/unified1/SPIRV.html#Decoration</a></p>
</blockquote>
<p>对于 gl_FragCoord：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">                      OpName %gl_FragCoord &quot;gl_FragCoord&quot;</span><br><span class="line">                      OpDecorate %gl_FragCoord BuiltIn FragCoord</span><br><span class="line">%_ptr_Input_v4float = OpTypePointer Input %v4float</span><br><span class="line">      %gl_FragCoord = OpVariable %_ptr_Input_v4float Input</span><br></pre></td></tr></table></figure>

<p>对于 Input Variable：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">                      OpName %vertColor &quot;vertColor&quot;</span><br><span class="line">                      OpDecorate %vertColor Location 0</span><br><span class="line">%_ptr_Input_v4float = OpTypePointer Input %v4float</span><br><span class="line">                      %vertColor = OpVariable %_ptr_Input_v4float Input</span><br></pre></td></tr></table></figure>

<p>对于 Output Variable：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">                       OpName %outColor &quot;outColor&quot;</span><br><span class="line">                       OpDecorate %outColor Location 0</span><br><span class="line">%_ptr_Output_v4float = OpTypePointer Output %v4float</span><br><span class="line">           %outColor = OpVariable %_ptr_Output_v4float Output</span><br></pre></td></tr></table></figure>

<p>使用时直接 <code>OpLoad</code> 就可以。</p>
<h4 id="Uniform-Block-Anonymous"><a href="#Uniform-Block-Anonymous" class="headerlink" title="Uniform Block (Anonymous)"></a>Uniform Block (Anonymous)</h4><blockquote>
<p>匿名的 Uniform Block，其成员是被引入了 Global Scope 的。</p>
<p>可以作为 OpenGL 的 uniforms outside a block 的平替。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">               OpName %uniBlock &quot;uniBlock&quot;</span><br><span class="line">               OpMemberName %uniBlock 0 &quot;lightPos&quot;</span><br><span class="line">               OpMemberName %uniBlock 1 &quot;someOtherFloat&quot;</span><br><span class="line">               OpName %_ &quot;&quot;</span><br><span class="line">               OpMemberDecorate %uniBlock 0 Offset 0             ; Structure type = %uniBlock</span><br><span class="line">                                                                 ; Member = 0</span><br><span class="line">                                                                 ; Decoration = Offset</span><br><span class="line">                                                                 ; Byte Offset = 0</span><br><span class="line">               OpMemberDecorate %uniBlock 1 Offset 12</span><br><span class="line">               OpDecorate %uniBlock Block                        ; Apply only to a structure type to establish</span><br><span class="line">                                                                 ; it is a memory interface block</span><br><span class="line">               OpDecorate %_ DescriptorSet 0                     ; Apply only to a variable. </span><br><span class="line">                                                                 ; Descriptor Set is an unsigned 32-bit integer </span><br><span class="line">                                                                 ; forming part of the linkage between the client</span><br><span class="line">                                                                 ; API and SPIR-V memory buffers, images, etc. </span><br><span class="line">                                                                 ; See the client API specification for more detail.</span><br><span class="line">               OpDecorate %_ Binding 0                           ; Apply only to a variable.</span><br><span class="line">                                                                 ; Binding Point is an unsigned 32-bit integer</span><br><span class="line">                                                                 ; forming part of the linkage between the client</span><br><span class="line">                                                                 ; API and SPIR-V memory buffers, images, etc.</span><br><span class="line">                                                                 ; See the client API specification for more detail.</span><br><span class="line">   %uniBlock = OpTypeStruct %v3float %float                      ; 后面指定所有成员的类型，这里是 &#123;vec3, float&#125;</span><br><span class="line">%_ptr_Uniform_uniBlock = OpTypePointer Uniform %uniBlock         ; Storage Class = Uniform</span><br><span class="line">          %_ = OpVariable %_ptr_Uniform_uniBlock Uniform</span><br><span class="line">%_ptr_Uniform_v3float = OpTypePointer Uniform %v3float</span><br><span class="line"></span><br><span class="line">         %34 = OpAccessChain %_ptr_Uniform_v3float %_ %int_0     ; Create a pointer into a composite object.</span><br><span class="line">                                                                 ; Base = %_, Indexes = &#123;%int_0&#125;</span><br><span class="line">                                                                 ; Each index in Indexes</span><br><span class="line">                                                                 ; - must have a scalar integer type</span><br><span class="line">                                                                 ; - is treated as signed</span><br><span class="line">                                                                 ; - if indexing into a structure, must be an </span><br><span class="line">                                                                 ;   OpConstant whose value is in bounds for selecting a member</span><br><span class="line">                                                                 ; - if indexing into a vector, array, or matrix, </span><br><span class="line">                                                                 ;   with the result type being a logical pointer type,</span><br><span class="line">                                                                 ;   causes undefined behavior if not in bounds.</span><br><span class="line">         %35 = OpLoad %v3float %34</span><br></pre></td></tr></table></figure>

<h4 id="Uniform-Block-Named"><a href="#Uniform-Block-Named" class="headerlink" title="Uniform Block (Named)"></a>Uniform Block (Named)</h4><p>把上面的示例程序里面的 <code>uniform uniBlock</code> 类型的不具名 Uniform Block 加一个实例名字：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">layout(binding=<span class="number">0</span>) uniform uniBlock &#123;</span><br><span class="line">    uniform vec3 lightPos;</span><br><span class="line">    uniform <span class="type">float</span> someOtherFloat;</span><br><span class="line">&#125; uniInst;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ..skip some lines..</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span> &#123;mainImage(outColor, gl_FragCoord.xy, uniInst.lightPos);&#125;</span><br></pre></td></tr></table></figure>

<p>下面是相关的 SPIR-V：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">               OpName %uniInst &quot;uniInst&quot;</span><br><span class="line">               OpDecorate %gl_FragCoord BuiltIn FragCoord</span><br><span class="line">               OpMemberDecorate %uniBlock 0 Offset 0</span><br><span class="line">               OpMemberDecorate %uniBlock 1 Offset 12</span><br><span class="line">               OpDecorate %uniBlock Block</span><br><span class="line">               OpDecorate %uniInst DescriptorSet 0</span><br><span class="line">               OpDecorate %uniInst Binding 0</span><br><span class="line">   %uniBlock = OpTypeStruct %v3float %float</span><br><span class="line">%_ptr_Uniform_uniBlock = OpTypePointer Uniform %uniBlock</span><br><span class="line">    %uniInst = OpVariable %_ptr_Uniform_uniBlock Uniform</span><br><span class="line">%_ptr_Uniform_uniBlock = OpTypePointer Uniform %uniBlock</span><br><span class="line">    %uniInst = OpVariable %_ptr_Uniform_uniBlock Uniform</span><br><span class="line">         %34 = OpAccessChain %_ptr_Uniform_v3float %uniInst %int_0</span><br><span class="line">         %35 = OpLoad %v3float %34</span><br></pre></td></tr></table></figure>

<p>可以看到，主要区别是 <code>%_</code> 变成了 <code>%uniInst</code>，其实就是 OpName 从 <code>&quot;&quot;</code> 变成了 <code>&quot;uniInst&quot;</code>，这样 SPIR-V 反汇编工具生成的反汇编能更好看一些而已。真正的 Result ID 等的逻辑关系都是没有变化的。</p>
<blockquote>
<p>当然，不知道反射库依赖不依赖 <code>OpName</code>，当然去掉了也不是没法反射就是了，只要 layout 一样，怼上去就得了。</p>
</blockquote>
<h3 id="Sampler"><a href="#Sampler" class="headerlink" title="Sampler"></a>Sampler</h3><p>GLSL 源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line"></span><br><span class="line">layout (binding = <span class="number">1</span>) uniform sampler2D samplerColor;</span><br><span class="line">layout (binding = <span class="number">2</span>) uniform texture2D tex;</span><br><span class="line">layout (binding = <span class="number">3</span>) uniform sampler samp;</span><br><span class="line">layout (location = <span class="number">0</span>) in vec2 inUV;</span><br><span class="line">layout (location = <span class="number">1</span>) in <span class="type">float</span> inLodBias;</span><br><span class="line">layout (location = <span class="number">0</span>) out vec4 outFragColor;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">    vec4 color = texture(samplerColor, inUV, inLodBias);</span><br><span class="line">      vec4 color2 = texture(sampler2D(tex, samp), inUV, inLodBias);</span><br><span class="line">    outFragColor = color + color2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SPIR-V 反汇编：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">; SPIR-V</span><br><span class="line">; Version: 1.0</span><br><span class="line">; Generator: Khronos Glslang Reference Front End; 10</span><br><span class="line">; Bound: 40</span><br><span class="line">; Schema: 0</span><br><span class="line">               OpCapability Shader</span><br><span class="line">          %1 = OpExtInstImport &quot;GLSL.std.450&quot;</span><br><span class="line">               OpMemoryModel Logical GLSL450</span><br><span class="line">               OpEntryPoint Fragment %main &quot;main&quot; %inUV %inLodBias %outFragColor</span><br><span class="line">               OpExecutionMode %main OriginUpperLeft</span><br><span class="line">               OpSource GLSL 450</span><br><span class="line">               OpName %main &quot;main&quot;</span><br><span class="line">               OpName %color &quot;color&quot;</span><br><span class="line">               OpName %samplerColor &quot;samplerColor&quot;</span><br><span class="line">               OpName %inUV &quot;inUV&quot;</span><br><span class="line">               OpName %inLodBias &quot;inLodBias&quot;</span><br><span class="line">               OpName %color2 &quot;color2&quot;</span><br><span class="line">               OpName %tex &quot;tex&quot;</span><br><span class="line">               OpName %samp &quot;samp&quot;</span><br><span class="line">               OpName %outFragColor &quot;outFragColor&quot;</span><br><span class="line">               OpDecorate %samplerColor DescriptorSet 0</span><br><span class="line">               OpDecorate %samplerColor Binding 1</span><br><span class="line">               OpDecorate %inUV Location 0</span><br><span class="line">               OpDecorate %inLodBias Location 1</span><br><span class="line">               OpDecorate %tex DescriptorSet 0</span><br><span class="line">               OpDecorate %tex Binding 2</span><br><span class="line">               OpDecorate %samp DescriptorSet 0</span><br><span class="line">               OpDecorate %samp Binding 3</span><br><span class="line">               OpDecorate %outFragColor Location 0</span><br><span class="line">       %void = OpTypeVoid</span><br><span class="line">          %3 = OpTypeFunction %void</span><br><span class="line">      %float = OpTypeFloat 32</span><br><span class="line">    %v4float = OpTypeVector %float 4</span><br><span class="line">%_ptr_Function_v4float = OpTypePointer Function %v4float</span><br><span class="line">         %10 = OpTypeImage %float 2D 0 0 0 1 Unknown</span><br><span class="line">         %11 = OpTypeSampledImage %10</span><br><span class="line">%_ptr_UniformConstant_11 = OpTypePointer UniformConstant %11</span><br><span class="line">%samplerColor = OpVariable %_ptr_UniformConstant_11 UniformConstant</span><br><span class="line">    %v2float = OpTypeVector %float 2</span><br><span class="line">%_ptr_Input_v2float = OpTypePointer Input %v2float</span><br><span class="line">       %inUV = OpVariable %_ptr_Input_v2float Input</span><br><span class="line">%_ptr_Input_float = OpTypePointer Input %float</span><br><span class="line">  %inLodBias = OpVariable %_ptr_Input_float Input</span><br><span class="line">%_ptr_UniformConstant_10 = OpTypePointer UniformConstant %10</span><br><span class="line">        %tex = OpVariable %_ptr_UniformConstant_10 UniformConstant</span><br><span class="line">         %27 = OpTypeSampler</span><br><span class="line">%_ptr_UniformConstant_27 = OpTypePointer UniformConstant %27</span><br><span class="line">       %samp = OpVariable %_ptr_UniformConstant_27 UniformConstant</span><br><span class="line">%_ptr_Output_v4float = OpTypePointer Output %v4float</span><br><span class="line">%outFragColor = OpVariable %_ptr_Output_v4float Output</span><br><span class="line"></span><br><span class="line">       %main = OpFunction %void None %3</span><br><span class="line">          %5 = OpLabel</span><br><span class="line">      %color = OpVariable %_ptr_Function_v4float Function</span><br><span class="line">     %color2 = OpVariable %_ptr_Function_v4float Function</span><br><span class="line">         %14 = OpLoad %11 %samplerColor</span><br><span class="line">         %18 = OpLoad %v2float %inUV</span><br><span class="line">         %21 = OpLoad %float %inLodBias</span><br><span class="line">         %22 = OpImageSampleImplicitLod %v4float %14 %18 Bias %21</span><br><span class="line">               OpStore %color %22</span><br><span class="line">         %26 = OpLoad %10 %tex</span><br><span class="line">         %30 = OpLoad %27 %samp</span><br><span class="line">         %31 = OpSampledImage %11 %26 %30</span><br><span class="line">         %32 = OpLoad %v2float %inUV</span><br><span class="line">         %33 = OpLoad %float %inLodBias</span><br><span class="line">         %34 = OpImageSampleImplicitLod %v4float %31 %32 Bias %33</span><br><span class="line">               OpStore %color2 %34</span><br><span class="line">         %37 = OpLoad %v4float %color</span><br><span class="line">         %38 = OpLoad %v4float %color2</span><br><span class="line">         %39 = OpFAdd %v4float %37 %38</span><br><span class="line">               OpStore %outFragColor %39</span><br><span class="line">               OpReturn</span><br><span class="line">               OpFunctionEnd</span><br></pre></td></tr></table></figure>

<p>总结如下：</p>
<ul>
<li>Sampler (<code>VK_DESCRIPTOR_TYPE_SAMPLER</code>)<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">OpName %samp &quot;samp&quot;</span><br><span class="line">OpDecorate %samp DescriptorSet 0</span><br><span class="line">OpDecorate %samp Binding 3</span><br><span class="line"></span><br><span class="line">%27 = OpTypeSampler</span><br><span class="line">%_ptr_UniformConstant_27 = OpTypePointer UniformConstant %27</span><br><span class="line">%samp = OpVariable %_ptr_UniformConstant_27 UniformConstant</span><br></pre></td></tr></table></figure></li>
<li>Sampled Image (<code>VK_DESCRIPTOR_TYPE_SAMPLED_IMAGE</code>)<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">OpName %tex &quot;tex&quot;</span><br><span class="line">OpDecorate %tex DescriptorSet 0</span><br><span class="line">OpDecorate %tex Binding 2</span><br><span class="line"></span><br><span class="line">%10 = OpTypeImage %float 2D 0 0 0 1 Unknown</span><br><span class="line">%_ptr_UniformConstant_10 = OpTypePointer UniformConstant %10</span><br><span class="line">%tex = OpVariable %_ptr_UniformConstant_10 UniformConstant</span><br><span class="line"></span><br><span class="line">; 使用</span><br><span class="line">%26 = OpLoad %10 %tex</span><br><span class="line">%30 = OpLoad %27 %samp</span><br><span class="line">%31 = OpSampledImage %11 %26 %30</span><br><span class="line">%32 = OpLoad %v2float %inUV</span><br><span class="line">%33 = OpLoad %float %inLodBias</span><br><span class="line">%34 = OpImageSampleImplicitLod %v4float %31 %32 Bias %33</span><br></pre></td></tr></table></figure></li>
<li>Combined Image Sampler (<code>VK_DESCRIPTOR_TYPE_COMBINED_IMAGE_SAMPLER</code>)<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">OpName %samplerColor &quot;samplerColor&quot;</span><br><span class="line">OpDecorate %samplerColor DescriptorSet 0</span><br><span class="line">OpDecorate %samplerColor Binding 1</span><br><span class="line"></span><br><span class="line">%10 = OpTypeImage %float 2D 0 0 0 1 Unknown</span><br><span class="line">%11 = OpTypeSampledImage %10</span><br><span class="line">%_ptr_UniformConstant_11 = OpTypePointer UniformConstant %11</span><br><span class="line">%samplerColor = OpVariable %_ptr_UniformConstant_11 UniformConstant</span><br><span class="line"></span><br><span class="line">; 使用</span><br><span class="line">%14 = OpLoad %11 %samplerColor</span><br><span class="line">%18 = OpLoad %v2float %inUV</span><br><span class="line">%21 = OpLoad %float %inLodBias</span><br><span class="line">%22 = OpImageSampleImplicitLod %v4float %14 %18 Bias %21</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>注意关于 OpImage 和 OpSampledImage 的特殊规则：</p>
<ul>
<li>All <code>OpSampledImage</code> instructions must be in the same block in which their Result <code>&lt;id&gt;</code> are consumed. Result <code>&lt;id&gt;</code> from <code>OpSampledImage</code> instructions must not appear as operands to <code>OpPhi</code> instructions or <code>OpSelect</code> instructions, or any instructions other than the image lookup and query instructions specified to take an operand whose type is OpTypeSampledImage.</li>
<li>在 <code>spvtools::opt::InstrumentPass::MovePreludeCode @ source/opt/instrument_pass.cpp (SPIRV-Tools)</code> 中对该要求进行了处理。</li>
</ul>
</blockquote>
<h3 id="Storage-Buffer"><a href="#Storage-Buffer" class="headerlink" title="Storage Buffer"></a>Storage Buffer</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap14.html#descriptorsets-storagebuffer">14.1.7. Storage Buffer</a></p>
</blockquote>
<blockquote>
<p>我的一个疑惑：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不可以编译通过</span></span><br><span class="line">layout(std430, <span class="built_in">set</span> = <span class="number">1</span>, binding = <span class="number">0</span>) readonly buffer objectBufferType &#123;</span><br><span class="line">    <span class="type">float</span> someBeginningVar;</span><br><span class="line">    ObjectData objects[]; </span><br><span class="line">    <span class="type">float</span> someEndingVar;</span><br><span class="line">&#125; objectBuffer;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可以，参考 https://github.com/KhronosGroup/SPIRV-Guide/blob/master/chapters/access_chains.md</span></span><br><span class="line"><span class="comment">// 的例子</span></span><br><span class="line">layout(std430, <span class="built_in">set</span> = <span class="number">1</span>, binding = <span class="number">0</span>) readonly buffer objectBufferType &#123;</span><br><span class="line">    <span class="type">float</span> someBeginningVar;</span><br><span class="line">    ObjectData objects[];</span><br><span class="line">&#125; objectBuffer;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// （应该）可以编译通过</span></span><br><span class="line">layout(std430, <span class="built_in">set</span> = <span class="number">1</span>, binding = <span class="number">0</span>) readonly buffer objectBufferType &#123;</span><br><span class="line">    <span class="type">float</span> someBeginningVar;</span><br><span class="line">&#125; objectBuffer;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>GLSL 源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line"></span><br><span class="line">layout (location = <span class="number">0</span>) out vec4 outFragColor;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ObjectData</span> &#123;</span></span><br><span class="line">    vec4 model;</span><br><span class="line">    <span class="type">float</span> moreData;</span><br><span class="line">    vec4 padThis;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">WritableData</span> &#123;</span></span><br><span class="line">    <span class="type">float</span> testData;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// std430 vs std140: https://www.khronos.org/opengl/wiki/Interface_Block_(GLSL)</span></span><br><span class="line">layout(std430, <span class="built_in">set</span> = <span class="number">1</span>, binding = <span class="number">0</span>) readonly buffer objectBufferType &#123;</span><br><span class="line">    ObjectData objects[];</span><br><span class="line">&#125; objectBuffer;</span><br><span class="line"></span><br><span class="line">layout(std430, <span class="built_in">set</span> = <span class="number">1</span>, binding = <span class="number">1</span>) buffer myWritableBufferType &#123;</span><br><span class="line">    WritableData datas[];</span><br><span class="line">&#125; writableBuffer;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> index = <span class="type">int</span>(gl_FragCoord.x * <span class="number">1000</span>);</span><br><span class="line">    outFragColor = objectBuffer.objects[index].model;</span><br><span class="line">    writableBuffer.datas[index].testData = <span class="number">123</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SPIR-V 反汇编：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">; SPIR-V</span><br><span class="line">; Version: 1.0</span><br><span class="line">; Generator: Khronos Glslang Reference Front End; 10</span><br><span class="line">; Bound: 42</span><br><span class="line">; Schema: 0</span><br><span class="line">               OpCapability Shader</span><br><span class="line">          %1 = OpExtInstImport &quot;GLSL.std.450&quot;</span><br><span class="line">               OpMemoryModel Logical GLSL450</span><br><span class="line">               OpEntryPoint Fragment %main &quot;main&quot; %gl_FragCoord %outFragColor</span><br><span class="line">               OpExecutionMode %main OriginUpperLeft</span><br><span class="line">               OpSource GLSL 450</span><br><span class="line">               OpName %main &quot;main&quot;</span><br><span class="line">               OpName %index &quot;index&quot;</span><br><span class="line">               OpName %gl_FragCoord &quot;gl_FragCoord&quot;</span><br><span class="line">               OpName %outFragColor &quot;outFragColor&quot;</span><br><span class="line">               OpName %ObjectData &quot;ObjectData&quot;</span><br><span class="line">               OpMemberName %ObjectData 0 &quot;model&quot;</span><br><span class="line">               OpMemberName %ObjectData 1 &quot;moreData&quot;</span><br><span class="line">               OpMemberName %ObjectData 2 &quot;padThis&quot;</span><br><span class="line">               OpName %objectBufferType &quot;objectBufferType&quot;</span><br><span class="line">               OpMemberName %objectBufferType 0 &quot;objects&quot;</span><br><span class="line">               OpName %objectBuffer &quot;objectBuffer&quot;</span><br><span class="line">               OpName %WritableData &quot;WritableData&quot;</span><br><span class="line">               OpMemberName %WritableData 0 &quot;testData&quot;</span><br><span class="line">               OpName %myWritableBufferType &quot;myWritableBufferType&quot;</span><br><span class="line">               OpMemberName %myWritableBufferType 0 &quot;datas&quot;</span><br><span class="line">               OpName %writableBuffer &quot;writableBuffer&quot;</span><br><span class="line">               OpDecorate %gl_FragCoord BuiltIn FragCoord</span><br><span class="line">               OpDecorate %outFragColor Location 0</span><br><span class="line">               OpMemberDecorate %ObjectData 0 Offset 0</span><br><span class="line">               OpMemberDecorate %ObjectData 1 Offset 16</span><br><span class="line">               OpMemberDecorate %ObjectData 2 Offset 32</span><br><span class="line">               OpDecorate %_runtimearr_ObjectData ArrayStride 48</span><br><span class="line">               OpMemberDecorate %objectBufferType 0 NonWritable</span><br><span class="line">               OpMemberDecorate %objectBufferType 0 Offset 0</span><br><span class="line">               OpDecorate %objectBufferType BufferBlock</span><br><span class="line">               OpDecorate %objectBuffer DescriptorSet 1</span><br><span class="line">               OpDecorate %objectBuffer Binding 0</span><br><span class="line">               OpMemberDecorate %WritableData 0 Offset 0</span><br><span class="line">               OpDecorate %_runtimearr_WritableData ArrayStride 4</span><br><span class="line">               OpMemberDecorate %myWritableBufferType 0 Offset 0</span><br><span class="line">               OpDecorate %myWritableBufferType BufferBlock</span><br><span class="line">               OpDecorate %writableBuffer DescriptorSet 1</span><br><span class="line">               OpDecorate %writableBuffer Binding 1</span><br><span class="line">       %void = OpTypeVoid</span><br><span class="line">          %3 = OpTypeFunction %void</span><br><span class="line">        %int = OpTypeInt 32 1</span><br><span class="line">%_ptr_Function_int = OpTypePointer Function %int</span><br><span class="line">      %float = OpTypeFloat 32</span><br><span class="line">    %v4float = OpTypeVector %float 4</span><br><span class="line">%_ptr_Input_v4float = OpTypePointer Input %v4float</span><br><span class="line">%gl_FragCoord = OpVariable %_ptr_Input_v4float Input</span><br><span class="line">       %uint = OpTypeInt 32 0</span><br><span class="line">     %uint_0 = OpConstant %uint 0</span><br><span class="line">%_ptr_Input_float = OpTypePointer Input %float</span><br><span class="line"> %float_1000 = OpConstant %float 1000</span><br><span class="line">%_ptr_Output_v4float = OpTypePointer Output %v4float</span><br><span class="line">%outFragColor = OpVariable %_ptr_Output_v4float Output</span><br><span class="line"> %ObjectData = OpTypeStruct %v4float %float %v4float</span><br><span class="line">%_runtimearr_ObjectData = OpTypeRuntimeArray %ObjectData</span><br><span class="line">%objectBufferType = OpTypeStruct %_runtimearr_ObjectData</span><br><span class="line">%_ptr_Uniform_objectBufferType = OpTypePointer Uniform %objectBufferType</span><br><span class="line">%objectBuffer = OpVariable %_ptr_Uniform_objectBufferType Uniform</span><br><span class="line">      %int_0 = OpConstant %int 0</span><br><span class="line">%_ptr_Uniform_v4float = OpTypePointer Uniform %v4float</span><br><span class="line">%WritableData = OpTypeStruct %float</span><br><span class="line">%_runtimearr_WritableData = OpTypeRuntimeArray %WritableData</span><br><span class="line">%myWritableBufferType = OpTypeStruct %_runtimearr_WritableData</span><br><span class="line">%_ptr_Uniform_myWritableBufferType = OpTypePointer Uniform %myWritableBufferType</span><br><span class="line">%writableBuffer = OpVariable %_ptr_Uniform_myWritableBufferType Uniform</span><br><span class="line">  %float_123 = OpConstant %float 123</span><br><span class="line">%_ptr_Uniform_float = OpTypePointer Uniform %float</span><br><span class="line"></span><br><span class="line">       %main = OpFunction %void None %3</span><br><span class="line">          %5 = OpLabel</span><br><span class="line">      %index = OpVariable %_ptr_Function_int Function</span><br><span class="line">         %16 = OpAccessChain %_ptr_Input_float %gl_FragCoord %uint_0</span><br><span class="line">         %17 = OpLoad %float %16</span><br><span class="line">         %19 = OpFMul %float %17 %float_1000</span><br><span class="line">         %20 = OpConvertFToS %int %19</span><br><span class="line">               OpStore %index %20</span><br><span class="line">         %29 = OpLoad %int %index</span><br><span class="line">         %31 = OpAccessChain %_ptr_Uniform_v4float %objectBuffer %int_0 %29 %int_0</span><br><span class="line">         %32 = OpLoad %v4float %31</span><br><span class="line">               OpStore %outFragColor %32</span><br><span class="line">         %38 = OpLoad %int %index</span><br><span class="line">         %41 = OpAccessChain %_ptr_Uniform_float %writableBuffer %int_0 %38 %int_0</span><br><span class="line">               OpStore %41 %float_123</span><br><span class="line">               OpReturn</span><br><span class="line">               OpFunctionEnd</span><br></pre></td></tr></table></figure>

<p>总结：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">               OpName %ObjectData &quot;ObjectData&quot;</span><br><span class="line">               OpMemberName %ObjectData 0 &quot;model&quot;</span><br><span class="line">               OpMemberName %ObjectData 1 &quot;moreData&quot;</span><br><span class="line">               OpMemberName %ObjectData 2 &quot;padThis&quot;</span><br><span class="line"></span><br><span class="line">               OpName %objectBufferType &quot;objectBufferType&quot;</span><br><span class="line">               OpMemberName %objectBufferType 0 &quot;objects&quot;</span><br><span class="line">               OpName %objectBuffer &quot;objectBuffer&quot;</span><br><span class="line">               OpMemberDecorate %ObjectData 0 Offset 0</span><br><span class="line">               OpMemberDecorate %ObjectData 1 Offset 16</span><br><span class="line">               OpMemberDecorate %ObjectData 2 Offset 32</span><br><span class="line">               OpDecorate %_runtimearr_ObjectData ArrayStride 48</span><br><span class="line">               OpMemberDecorate %objectBufferType 0 NonWritable    ; 如果可变则无此 decorate</span><br><span class="line">               OpMemberDecorate %objectBufferType 0 Offset 0</span><br><span class="line">               OpDecorate %objectBufferType BufferBlock</span><br><span class="line">               OpDecorate %objectBuffer DescriptorSet 1</span><br><span class="line">               OpDecorate %objectBuffer Binding 0</span><br><span class="line"> %ObjectData = OpTypeStruct %v4float %float %v4float</span><br><span class="line">%_runtimearr_ObjectData = OpTypeRuntimeArray %ObjectData           ; Declare a new run-time array type.</span><br><span class="line">                                                                   ; Its length is not known at compile time.</span><br><span class="line">                                                                   ; See OpArrayLength for getting the Length</span><br><span class="line">                                                                   ; of an array of this type.</span><br><span class="line">%objectBufferType = OpTypeStruct %_runtimearr_ObjectData</span><br><span class="line">%_ptr_Uniform_objectBufferType = OpTypePointer Uniform %objectBufferType</span><br><span class="line">%objectBuffer = OpVariable %_ptr_Uniform_objectBufferType Uniform</span><br><span class="line"></span><br><span class="line">; 访问</span><br><span class="line">; 使用 OpAccessChain 指令，该指令是 base, indices... 格式</span><br><span class="line">; 此例子： objectBuffer[0 th][index th][0 th] 来获得 model 的指针，该指针之后可以 load / store</span><br><span class="line">         %29 = OpLoad %int %index</span><br><span class="line">         %31 = OpAccessChain %_ptr_Uniform_v4float %objectBuffer %int_0 %29 %int_0</span><br></pre></td></tr></table></figure>

<h3 id="Atomic-操作"><a href="#Atomic-操作" class="headerlink" title="Atomic 操作"></a>Atomic 操作</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/KhronosGroup/Vulkan-Guide/blob/main/chapters/atomics.adoc">https://github.com/KhronosGroup/Vulkan-Guide/blob/main/chapters/atomics.adoc</a></p>
</blockquote>
<p>GLSL 源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line"></span><br><span class="line">layout (location = <span class="number">0</span>) out vec4 outFragColor;</span><br><span class="line"></span><br><span class="line"><span class="comment">// std430 vs std140: https://www.khronos.org/opengl/wiki/Interface_Block_(GLSL)</span></span><br><span class="line">layout(std430, <span class="built_in">set</span> = <span class="number">1</span>, binding = <span class="number">0</span>) buffer statsBufferType &#123;</span><br><span class="line">    <span class="type">int</span> totalInvocations;</span><br><span class="line">&#125; statsBuffer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// returns the value before the add</span></span><br><span class="line">    <span class="type">int</span> globalIdx = atomicAdd(statsBuffer.totalInvocations, <span class="number">1</span>);</span><br><span class="line">    outFragColor = vec4(<span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SPIR-V 反汇编：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">; SPIR-V</span><br><span class="line">; Version: 1.0</span><br><span class="line">; Generator: Khronos Glslang Reference Front End; 10</span><br><span class="line">; Bound: 26</span><br><span class="line">; Schema: 0</span><br><span class="line">               OpCapability Shader</span><br><span class="line">          %1 = OpExtInstImport &quot;GLSL.std.450&quot;</span><br><span class="line">               OpMemoryModel Logical GLSL450</span><br><span class="line">               OpEntryPoint Fragment %main &quot;main&quot; %outFragColor</span><br><span class="line">               OpExecutionMode %main OriginUpperLeft</span><br><span class="line">               OpSource GLSL 450</span><br><span class="line">               OpName %main &quot;main&quot;</span><br><span class="line">               OpName %globalIdx &quot;globalIdx&quot;</span><br><span class="line">               OpName %statsBufferType &quot;statsBufferType&quot;</span><br><span class="line">               OpMemberName %statsBufferType 0 &quot;totalInvocations&quot;</span><br><span class="line">               OpName %statsBuffer &quot;statsBuffer&quot;</span><br><span class="line">               OpName %outFragColor &quot;outFragColor&quot;</span><br><span class="line">               OpMemberDecorate %statsBufferType 0 Offset 0</span><br><span class="line">               OpDecorate %statsBufferType BufferBlock</span><br><span class="line">               OpDecorate %statsBuffer DescriptorSet 1</span><br><span class="line">               OpDecorate %statsBuffer Binding 0</span><br><span class="line">               OpDecorate %outFragColor Location 0</span><br><span class="line">       %void = OpTypeVoid</span><br><span class="line">          %3 = OpTypeFunction %void</span><br><span class="line">        %int = OpTypeInt 32 1</span><br><span class="line">%_ptr_Function_int = OpTypePointer Function %int</span><br><span class="line">%statsBufferType = OpTypeStruct %int</span><br><span class="line">%_ptr_Uniform_statsBufferType = OpTypePointer Uniform %statsBufferType</span><br><span class="line">%statsBuffer = OpVariable %_ptr_Uniform_statsBufferType Uniform</span><br><span class="line">      %int_0 = OpConstant %int 0</span><br><span class="line">%_ptr_Uniform_int = OpTypePointer Uniform %int</span><br><span class="line">      %int_1 = OpConstant %int 1</span><br><span class="line">       %uint = OpTypeInt 32 0</span><br><span class="line">     %uint_1 = OpConstant %uint 1</span><br><span class="line">     %uint_0 = OpConstant %uint 0</span><br><span class="line">      %float = OpTypeFloat 32</span><br><span class="line">    %v4float = OpTypeVector %float 4</span><br><span class="line">%_ptr_Output_v4float = OpTypePointer Output %v4float</span><br><span class="line">%outFragColor = OpVariable %_ptr_Output_v4float Output</span><br><span class="line">    %float_1 = OpConstant %float 1</span><br><span class="line">         %25 = OpConstantComposite %v4float %float_1 %float_1 %float_1 %float_1</span><br><span class="line">       %main = OpFunction %void None %3</span><br><span class="line">          %5 = OpLabel</span><br><span class="line">  %globalIdx = OpVariable %_ptr_Function_int Function</span><br><span class="line">         %14 = OpAccessChain %_ptr_Uniform_int %statsBuffer %int_0</span><br><span class="line">         %19 = OpAtomicIAdd %int %14 %uint_1 %uint_0 %int_1             ; Pointer = %14</span><br><span class="line">                                                                        ; Memory Scope = %uint_1 = 1</span><br><span class="line">                                                                        ; =&gt; Scope is the current device</span><br><span class="line">                                                                        ; Semantics = %uint_0 = 0</span><br><span class="line">                                                                        ; =&gt; None (relaxed)</span><br><span class="line">                                                                        ; Value = %uint_1 = 1</span><br><span class="line">               OpStore %globalIdx %19</span><br><span class="line">               OpStore %outFragColor %25</span><br><span class="line">               OpReturn</span><br><span class="line">               OpFunctionEnd</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Memory Scope: <a target="_blank" rel="noopener" href="https://registry.khronos.org/SPIR-V/specs/unified1/SPIRV.html#Scope_-id-">https://registry.khronos.org/SPIR-V/specs/unified1/SPIRV.html#Scope_-id-</a></p>
</blockquote>
<h2 id="Coming-soon"><a href="#Coming-soon" class="headerlink" title="Coming soon"></a>Coming soon</h2><ul>
<li>Matrix 类型</li>
<li>导数 <code>dFdx</code> &#x2F; <code>dFdy</code> &amp; <code>discard</code><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/gpuweb/gpuweb/issues/361">https://github.com/gpuweb/gpuweb/issues/361</a></li>
<li><a target="_blank" rel="noopener" href="http://www.xionggf.com/post/opengl/an_introduction_to_shader_derivative_functions/">http://www.xionggf.com/post/opengl/an_introduction_to_shader_derivative_functions/</a></li>
</ul>
</li>
<li>Group Ops</li>
</ul>

      
     <!-- by blair add this if sentence at 20160725 -->
      <br>
      
<!-- <div id="bottom-donation-section"> -->
<!-- <span style="font-size: 1.0em; padding:0em 1em 0.5em 1em; margin: 0 auto;">
  <strong style="vertical-align: top;">分享到:</strong>
    <div class="j_handlclick"  style="background: url(/images/logos/share_facebook_icon.jpg);background-size: contain;display: inline-block; width:50px; height:50px" href="https://www.facebook.com/sharer/sharer.php?u=" target="_blank">
    </div>
    <div class="j_handlclick"  style="background: url(/images/logos/share_twitter_icon.jpg);background-size: contain;display: inline-block; width:50px; height:50px" href="https://twitter.com/intent/tweet?url=" target="_blank">
    </div>
    <div class="j_handlclick"  style="background: url(/images/logos/share_line_icon.jpg);background-size: contain;display: inline-block; width:50px; height:50px" href="https://www.addtoany.com/add_to/line?linkurl=" target="_blank">
    </div>
    <div class="j_handlclick"  style="background: url(/images/logos/share_wechat_icon.jpg);background-size: contain;display: inline-block; width:50px; height:50px" href="https://api.addthis.com/oexchange/0.8/forward/wechat/offer?url=" target="_blank">
    </div>
  <br>  
  <br>  
  &nbsp;&nbsp;如果您觉得这篇文章对您的学习很有帮助, 请您也分享它, 让它能再次帮助到更多的需要学习的人.
您的<a href="/support/"><strong>支持</strong></a>将鼓励我继续创作 !
  <br>  

</span> -->
<!--
<h3 id="bottom-donation-title">支持 让文章变得更优质</h3>
<div>
<a id="bottom-donation-button" href="/support">点我 赞助 作者</a>
</div>
-->
<!-- </div> -->
<!-- <div class="well"> -->
  <!--
  原创文章，转载请注明： 转载自<a target="_blank" rel="noopener" href="http://52binge.github.io"> Blair Chan's Blog</a>，作者：
  <a href="/about">Blair Chan</a> <br>
  -->
  <!-- 本文基于<a target="_blank" title="Creative Commons Attribution 4.0 international License" href="https://creativecommons.org/licenses/by-nc/4.0/">署名4.0国际许可协议</a>发布，转载请保留本文署名和文章链接。 如您有任何授权方面的协商，请邮件联系我。 -->
<!-- </div> -->
 <!-- by blair add 160724-->
    
    </div>
    
      <div class="article-toc">
        <h3>Contents</h3>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-text">简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#See-Also"><span class="toc-text">See Also</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90"><span class="toc-text">例子</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Layout"><span class="toc-text">Layout</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%A7%82"><span class="toc-text">概观</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-text">简单的函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E7%9A%84-in-x2F-out-%E5%8F%82%E6%95%B0"><span class="toc-text">函数的 in &#x2F; out 参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%94%AF"><span class="toc-text">分支</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AF"><span class="toc-text">循环</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%AF%E8%AF%AD"><span class="toc-text">术语</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#while-%E5%BE%AA%E7%8E%AF-%E6%97%A0-break"><span class="toc-text">while 循环 - 无 break</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#while-%E5%BE%AA%E7%8E%AF-%E5%B8%A6-break"><span class="toc-text">while 循环 - 带 break</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#for-%E5%BE%AA%E7%8E%AF"><span class="toc-text">for 循环</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Uniform%E3%80%81BuiltIn-%E7%AD%89%E5%85%B6%E5%AE%83-Scope-%E7%9A%84%E5%8F%98%E9%87%8F"><span class="toc-text">Uniform、BuiltIn 等其它 Scope 的变量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Input-x2F-Output"><span class="toc-text">Input &#x2F; Output</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Uniform-Block-Anonymous"><span class="toc-text">Uniform Block (Anonymous)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Uniform-Block-Named"><span class="toc-text">Uniform Block (Named)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sampler"><span class="toc-text">Sampler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Storage-Buffer"><span class="toc-text">Storage Buffer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Atomic-%E6%93%8D%E4%BD%9C"><span class="toc-text">Atomic 操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Coming-soon"><span class="toc-text">Coming soon</span></a></li></ol>
      </div>
    
    
      <footer class="article-footer">
        <!-- <div class="well" style="width:100px; height:30px;"></div>  by blair-->
        
 <!-- by blair add 160724-->
        <!--
        <div style="width:100px; height:30px;"></div> by blair add 160724
        -->
        

      </footer>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/qem-mesh-simplification/" id="article-nav-newer" class="article-nav-link-wrap">
      <div class="article-nav-title"><span>&lt;</span>&nbsp;
        
          可能是史上最详尽的 QEM 网格简化算法解释
        
      </div>
    </a>
  
  
    <a href="/paper-reading/auto-shader-mesh-lod/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">论文阅读 | Automatic Mesh and Shader Level of Detail&nbsp;<span>&gt;</span></div>
    </a>
  
</nav>

  
</article>

</section>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2025 Libre Liu&nbsp;
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, theme by <a target="_blank" rel="noopener" href="http://github.com/52binge/hexo-theme-blairos">blairos</a>
    </div>
  </div>
</footer>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX"],
    tex2jax: {
      inlineMath: [ ['$','$'], ['\\(','\\)'] ],
      displayMath: [ ['$$','$$']],
      processEscapes: true
    }
  });
</script>
<script>
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ['\\(','\\)'] ],
      displayMath: [ ['$$','$$']],
      processEscapes: true,
    },
    options: {
    renderActions: {
      findScript: [10, function (doc) {
        for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
          const display = !!node.type.match(/; *mode=display/);
          const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
          const text = document.createTextNode('');
          node.parentNode.replaceChild(text, node);
          math.start = {node: text, delim: '', n: 0};
          math.end = {node: text, delim: '', n: 0};
          doc.math.push(math);
        }
      }, '']
    }
  }
  };
</script>
<script type="text/javascript" id="MathJax-script" src="/js/mathjax/tex-chtml.js">
</script>

    

<script src="/js/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>


  </div>
</body>
</html>
